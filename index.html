<!doctype html>
<html>
  <head>
<!--
    <script src="http://mrdoob.github.com/three.js/build/Three.js"></script>
-->
       
  </head>
  <body>
      <div id="controlpanel">
        <input type="button" class="btn-ctrl" id="btn-zin" value="ZoomIn"></input>
        <input type="button" class="btn-ctrl" id="btn-zout" value="ZoomOut"></input>
      </div>
      <script>
        var zoomin = document.getElementById("btn-zin");
        zoomin.onclick=function(){
          c.position.setZ(c.position.z/2.00>50?c.position.z/2.00>50:50);
          // r.render(s, c);
          // requestAnimationFrame(animate);
          console.log('zoomin');
        }
        var zoomout = document.getElementById("btn-zout");
        zoomout.onclick=function(){
          c.position.setZ(c.position.z*2.00<1000?c.position.z*2.00:1000);
          // r.render(s, c);
          // requestAnimationFrame(animate);
          console.log('zoomout');
        }

      </script>
  </body>
  <script src="three.min.js"></script>
    <script src="bitview.js"></script>
    <script src="shp.js"></script>
    <script src="shp_three.js"></script>
    <script src="TrackballControls.js"></script>
   <script>
      function save(buffer, name, mimetype) {
        var bb = new WebKitBlobBuilder();
        bb.append(buffer);
        var b = bb.getBlob();
        var url = webkitURL.createObjectURL(b);
        var a = document.createElement('a');
        a.download = name;
        a.mimetype = mimetype;
        a.href = url;
        a.click();
        webkitURL.revokeObjectURL(url);
      }
    </script>
    <script>
      // 定义我的对象，属性方法，可复用
      ThreeShp = {
        r:new THREE.WebGLRenderer(),
        s:new THREE.Scene(),
        loader :null,
        c:new THREE.PerspectiveCamera(41, window.innerWidth / window.innerHeight, 1, 100000)
      }
      ThreeShp.init = function(){        
        // set the canvas width and length
        this.r.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(this.r.domElement);
        // THREE data struct.. Scene.add(Mesh)/Object3D
        this.loader = new THREE.SHPLoader();
        // 照相机在三维空间中的位置。 
        this.c.position.z = 50;
        this.c.position.y = 23.11;
        this.c.position.x = 114.022;
        this.s.add(this.c);

        // 添加鼠标交互空间
        this.controls = new THREE.TrackballControls(this.c, this.r.domElement);
        this.controls.minDistance = 10;
        this.controls.maxDistance = 1000;
      }
      ThreeShp.rendershp = function(res) {
        // res is shp.js defined shpobj.
        console.log('parse shpfile finished', res);
        // // parsedShp = res;
        // var loader = new THREE.SHPLoader();
        // m instanceof THREE.Object3D, createModel(shp, SphereOrNot)
        var m = ThreeShp.loader.createModel(res, false);
        m.scale.set(1.01, 1.01, 1.01);
        console.log('created model', m);
        var compressed = ThreeShp.loader.compress(res);
        //save(compressed, '110m_land.i12d6')
        var n = ThreeShp.loader.loadCompressed(compressed, false);
        n.scale.set(1.01,1.01,1.01);
        n.position.z = 10;
        
        // ThreeShp.s.add(new THREE.Mesh(
        //   // new THREE.SphereGeometry(88, 64, 64),
        //   // SphereGeometry( radius, detail)
        //   new THREE.SphereGeometry(90, 100, 150),
        //   new THREE.MeshBasicMaterial({color: 0x0088FF, opacity: 0.2, depthWrite:false})
        // ));
        ThreeShp.s.add(m);
        ThreeShp.s.add(n);

        // Openlayer.View alike  -- PerspectiveCamera... Scene is needed!!.and Camera added to Scene!!!
        // // Camera(fov,canvwidth/canvheight,)
        // c = new THREE.PerspectiveCamera(41, window.innerWidth / window.innerHeight, 1, 100000);
        
        var t0 = new Date;
        // var animate = function(t) {
        //   var dt = t-t0;
        //   t0 = t;
        //   m.rotation.y += 0.0001 * dt;
        //   n.rotation.y += 0.0001 * dt;
        //   c.lookAt(new THREE.Vector3(0,0,0));
        //   r.render(s, c);
        //   //requestAnimationFrame(animate);
        // }
        //requestAnimationFrame(animate);
        //lookAt control the angle, right..
        ThreeShp.c.lookAt(new THREE.Vector3(0,0,0));
        ThreeShp.r.render(ThreeShp.s, ThreeShp.c);
        //addmouseMove();          
      }

      function err(res){ console.log('error', res); }

      var parsedShp = null;
      ThreeShp.init();
      SHPParser.load("110m_land.shp",ThreeShp.rendershp,err);
      // SHPParser.load("cpdmpop2010_poly_wgs.shp",ThreeShp.rendershp,err);

      // // six_counties.shp 110m_land.shp
      // SHPParser.load('110m_land.shp', 
      //   function(res) {
      //     // res is shp.js defined shpobj.
      //     console.log('ok', res);
      //     // parsedShp = res;
      //     var loader = new THREE.SHPLoader();
      //     // m instanceof THREE.Object3D, createModel(shp, SphereOrNot)
      //     var m = loader.createModel(res, false);
      //     m.scale.set(1.01, 1.01, 1.01);
      //     console.log('created model', m);
      //     var compressed = loader.compress(res);
      //     //save(compressed, '110m_land.i12d6')
      //     var n = loader.loadCompressed(compressed, false);
      //     n.scale.set(1.01,1.01,1.01);
      //     n.position.z = 10;
      //     r = new THREE.WebGLRenderer();
      //     // set the canvas width and length
      //     r.setSize(window.innerWidth, window.innerHeight);
      //     document.body.appendChild(r.domElement);
      //     // THREE data struct.. Scene.add(Mesh)/Object3D
      //     s = new THREE.Scene();
      //     // s.add(new THREE.Mesh(
      //     //   // new THREE.SphereGeometry(88, 64, 64),
      //     //   // SphereGeometry( radius, detail)
      //     //   new THREE.SphereGeometry(90, 100, 150),
      //     //   new THREE.MeshBasicMaterial({color: 0x0088FF, opacity: 0.2, depthWrite:false})
      //     // ));
      //     s.add(m);
      //     s.add(n);
      //     // Openlayer.View alike  -- PerspectiveCamera... Scene is needed!!.and Camera added to Scene!!!
      //     // Camera(fov,canvwidth/canvheight,)
      //     c = new THREE.PerspectiveCamera(41, window.innerWidth / window.innerHeight, 1, 100000);
      //     // 照相机在三维空间中的位置。 
      //     c.position.z = 50;
      //     c.position.y = 23.11;
      //     c.position.x = 114.022;
      //     s.add(c);
      //     var t0 = new Date;
      //     // var animate = function(t) {
      //     //   var dt = t-t0;
      //     //   t0 = t;
      //     //   m.rotation.y += 0.0001 * dt;
      //     //   n.rotation.y += 0.0001 * dt;
      //     //   c.lookAt(new THREE.Vector3(0,0,0));
      //     //   r.render(s, c);
      //     //   //requestAnimationFrame(animate);
      //     // }
      //     //requestAnimationFrame(animate);
      //     //lookAt control the angle, right..
      //     c.lookAt(new THREE.Vector3(0,0,0));
      //     r.render(s, c);
      //     addmouseMove();

      //     controls = new THREE.TrackballControls(c, r.domElement);
      //     controls.minDistance = 10;
      //     controls.maxDistance = 1000;
      //     },
      //   function(res){ console.log('error', res); }
      // );

      var addmouseMove = function(){
        var canvas = document.getElementsByTagName("canvas")[0];
        canvas.addEventListener("mousemove",function(){});
        console.log("mousemove listener added.");
      }

      animate();
      function animate() {
        requestAnimationFrame(animate);
        ThreeShp.controls.update();
        ThreeShp.r.render( ThreeShp.s, ThreeShp.c );
      }
    </script>

</html>
